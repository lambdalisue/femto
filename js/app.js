((function(){var a=[].slice;window.namespace=function(b,c,d){var e,f,g,h,i,j;arguments.length<3&&(i=[typeof exports!="undefined"?exports:window].concat(a.call(arguments)),b=i[0],c=i[1],d=i[2]),f=b,j=c.split(".");for(g=0,h=j.length;g<h;g++)e=j[g],b=b[e]||(b[e]={});return d(b,f)}})).call(this),function(){var a,b,c,d,e,f,g,h,i,j,k={}.hasOwnProperty,l=function(a,b){function d(){this.constructor=a}for(var c in b)k.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},m=function(a,b){return function(){return a.apply(b,arguments)}};f=function(a){var b,c,d;c={};for(b in a)d=a[b],a.hasOwnProperty(b)&&(c[b]=d);return c},g=function(a,b){var c,d;b=f(b);for(c in a)d=a[c],a.hasOwnProperty(c)&&(b[c]=d);return b},namespace("Femto.utils",function(a){return a.clone=f,a.extend=g}),a=function(){function a(a){this.textarea=a,this}return a.prototype._replace=function(a,b,c,d){var e,f;return e=a.substring(0,c),f=a.substring(d),e+b+f},a.prototype.get=function(){var a,b;return b=this.textarea.selectionStart,a=this.textarea.selectionEnd,[b,a]},a.prototype.set=function(a,b){var c,d;return b==null&&(c=a,d=this.get(),a=d[0],b=d[1],a+=c,b+=c),this.textarea.setSelectionRange(a,b),this},a.prototype.isCollapsed=function(){var a,b,c;return c=this.get(),b=c[0],a=c[1],b===a},a.prototype.collapse=function(a){var b,c,d;return d=this.get(),c=d[0],b=d[1],a===!0?this.set(c,c):this.set(b,b)},a.prototype.text=function(a,b){var c,d,e,f,g;return g=this.get(),d=g[0],c=g[1],f=this.textarea.value,a==null?f.substring(d,c):(e=this.textarea.scrollTop,f=this._replace(f,a,d,c),this.textarea.value=f,c=d+a.length,b||(d=c),this.set(d,c),this.textarea.scrollTop=e,this)},a.prototype.insertBefore=function(a,b){var c,d,e,f,g,h;return h=this.get(),d=h[0],c=h[1],e=this.textarea.scrollTop,g=this.textarea.value,f=g.substring(d,c),g=this._replace(g,a+f,d,c),this.textarea.value=g,c=d+a.length,b||(d=c),this.set(d,c),this.textarea.scrollTop=e,this},a.prototype.insertAfter=function(a,b){var c,d,e,f,g,h;return h=this.get(),d=h[0],c=h[1],e=this.textarea.scrollTop,g=this.textarea.value,f=g.substring(d,c),g=this._replace(g,f+a,d,c),this.textarea.value=g,d=c,c+=a.length,b||(d=c),this.set(d,c),this.textarea.scrollTop=e,this},a.prototype.enclose=function(a,b,c){var d,e,f,g,h,i,j,k;return i=function(a,b){return a.lastIndexOf(b,0)===0},e=function(a,b){var c;return c=a.length-b.length,c>=0&&a.indexOf(b,c)!==-1},g=this.textarea.scrollTop,j=this.textarea.value,h=this.text(),i(h,a)&&e(h,b)?(h=h.substring(a.length,h.length-b.length),this.text(h,c)):(k=this.get(),f=k[0],d=k[1],h=a+h+b,j=this._replace(j,h,f,d),this.textarea.value=j,d=f+h.length,c||(f=d),this.set(f,d)),this.textarea.scrollTop=g,this},a}(),namespace("Femto.utils",function(b){return b.Caret=a}),d=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return l(b,a),b.prototype.get=function(a,c){var d,e,f,g,h,i;if(a==null||c==null)i=b.__super__.get.call(this),e=i[0],d=i[1],a=a!=null?a:e,c=c!=null?c:d;return h=this.textarea.value,g=h.lastIndexOf("\n",a-1)+1,f=h.indexOf("\n",c),f===-1&&(f=h.length),[g,f]},b}(Femto.utils.Caret),namespace("Femto.utils",function(a){return a.LineCaret=d}),e=function(){function a(){}return a.prototype.createMemento=function(){throw Error("Not implemented yet")},a.prototype.setMemento=function(a){throw Error("Not implemented yet")},a}(),b=function(){function a(a){this._originator=a,this._undoStack=[],this._redoStack=[],this._previous=null}return a.prototype.originator=function(a){return a!=null?(this._originator=a,this):this._originator},a.prototype.save=function(a){a=a||this.originator().createMemento();if(this._previous==null||this._previous!==a)this._undoStack.length===0&&a!==""&&this._undoStack.push(""),this._undoStack.push(a),this._redoStack=[],this._previous=a;return this},a.prototype.undo=function(){var a;return this.canUndo()?(a=this.originator(),this._redoStack.push(a.createMemento()),a.setMemento(this._undoStack.pop()),this):this},a.prototype.redo=function(){var a;return this.canRedo()?(a=this.originator(),this._undoStack.push(a.createMemento()),a.setMemento(this._redoStack.pop()),this):this},a.prototype.canUndo=function(){return this._undoStack.length>0},a.prototype.canRedo=function(){return this._redoStack.length>0},a}(),typeof exports!="undefined"&&exports!==null&&(exports.Originator=e,exports.Caretaker=b),typeof namespace!="undefined"&&namespace!==null&&namespace("Femto.utils",function(a){return a.Originator=e,a.Caretaker=b}),c=function(){function a(a,b){this.textarea=a,this._keyDownEvent=m(this._keyDownEvent,this),this.options=Femto.utils.extend(b,{expandTab:!0,indentLevel:4}),this._newlinep=new RegExp("^(?:"+this._makeTabString(this.options.indentLevel)+")*"),this._leadingp=new RegExp("^\\s*"),this.caret=new Femto.utils.Caret(this.textarea),this.linecaret=new Femto.utils.LineCaret(this.textarea)}return a.prototype._makeTabString=function(a){var b;return this.options.expandTab?(b="_tabString"+a+"Cache",this[b]==null&&(this[b]=(new Array(a+1)).join(" ")),this[b]):"\t"},a.prototype._leadingSpaces=function(a){return a.match(this._leadingp)[0].length},a.prototype.indent=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r=this;return n=this.caret.text(),p=this.caret.get(),m=p[0],a=p[1],q=this.linecaret.get(),f=q[0],d=q[1],!this.caret.isCollapsed()&&n.indexOf("\n")!==-1?(b=function(a){var b,c,d;return r.options.expandTab?(b=r._leadingSpaces(a),c=b%r.options.indentLevel,d=r._makeTabString(r.options.indentLevel-c)):d=r._makeTabString(),d+a},e=this.linecaret.text().split("\n"),g=function(){var a,d,f;f=[];for(a=0,d=e.length;a<d;a++)c=e[a],f.push(b(c));return f}(),this.linecaret.text(g.join("\n"),!1),j=g[0].length-e[0].length,i=g.join("").length-e.join("").length,f!==m&&(m+=j),this.caret.set(m,a+i)):(this.options.expandTab?(l=m-f,k=l%this.options.indentLevel,o=this._makeTabString(this.options.indentLevel-k)):o=this._makeTabString(),h=o.length,this.caret.text(o+n,!1),this.caret.set(m+h,a+h)),this},a.prototype.outdent=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=this;r=this.caret.text(),t=this.caret.get(),q=t[0],a=t[1],u=this.linecaret.get(),h=u[0],d=u[1];if(!this.caret.isCollapsed()&&r.indexOf("\n")!==-1)m=function(a){var b,c,d;return v.options.expandTab?(b=v._leadingSpaces(a),c=b%v.options.indentLevel,d=v._makeTabString(v.options.indentLevel-c)):d=v._makeTabString(),a.replace(new RegExp("^"+d),"")},g=this.linecaret.text().split("\n"),i=function(){var a,b,d;d=[];for(a=0,b=g.length;a<b;a++)c=g[a],d.push(m(c));return d}(),this.linecaret.text(i.join("\n"),!1),l=i[0].length-g[0].length,k=i.join("").length-g.join("").length,h!==q&&(q+=l),this.caret.set(q,a+k);else{this.options.expandTab?(e=this._leadingSpaces(r),o=q-h+e,n=o%this.options.indentLevel,s=this._makeTabString(this.options.indentLevel-n)):s=this._makeTabString(),r=this.linecaret.text(),b=r.lastIndexOf(s,q-h);if(b===-1)return this;j=s.length,f=r.substring(0,b),p=r.substring(b+j),this.linecaret.text(f+p,!1),this.caret.set(q-j,a-j)}return this},a.prototype.insertNewLine=function(){var a,b,c,d,e,f,g;return g=this.caret.get(),e=g[0],a=g[1],f=this.textarea.value,d=f.lastIndexOf("\n",a-1)+1,b=f.substring(d,a).match(this._newlinep),c="\n"+b,this.caret.insertAfter(c,!1),e===a?this.caret.set(e+c.length,e+c.length):this.caret.set(e,a+c.length),this},a.prototype._keyDownEvent=function(a){if(a.which!==9&&a.which!==13)return!0;if(a.which===9)a.shiftKey?this.outdent():this.indent();else if(a.which===13){if(a.shiftKey)return!0;this.insertNewLine()}return a.stopPropagation(),a.preventDefault(),!1},a.prototype.enable=function(){return this.textarea.addEventListner("keydown",this._keyDownEvent,!1),this},a.prototype.disable=function(){return this.textarea.removeEventListner("keydown",this._keyDownEvent,!1),this},a}(),namespace("Femto.utils",function(a){return a.Indent=c}),h=function(a,b){var c,d,e,f;return b==null&&(b={}),b=Femto.utils.extend(b,{caretaker:!0,indent:!0,expandTab:!0,indentLevel:4}),d={},d.options=b,f=new Femto.utils.Originator,f.createMemento=function(){return a.value},f.setMemento=function(b){return a.value=b},c=new Femto.utils.Caretaker(f),c.save(),c._keyDownEvent=function(a){var b;((b=a.which)===13||b===9||b===8||b===46)&&c.save();if(a.which===90&&a.ctrlKey)return a.shiftKey?c.redo():c.undo(),a.stopPropagation(),a.preventDefault()},e=new Femto.utils.Indent(a,b),d.originator=f,d.caretaker=c,d.indent=e,d.caret=e.caret,d.linecaret=e.linecaret,d._keyDownEvent=function(a){b.caretaker&&c._keyDownEvent(a);if(b.indent)return e._keyDownEvent(a)},d._caretakerEvent=function(a){if(b.caretaker)return c.save()},d.enable=function(){return a.addEventListener("keydown",d._keyDownEvent,!1),a.addEventListener("paste",d._caretakerEvent,!1),a.addEventListener("drop",d._caretakerEvent,!1)},d.disable=function(){return a.removeEventListener("keydown",d._keyDownEvent,!1),a.removeEventListener("paste",d._caretakerEvent,!1),a.removeEventListener("drop",d._caretakerEvent,!1)},d.enable(),a.femto=d,a},i=function(a){var b,c,d,e,f;c=document.getElementsByTagName("textarea"),b=[];for(e=0,f=c.length;e<f;e++)d=c[e],b.push(h(d));return b},namespace("Femto",function(a){return a.transform=h,a.transformAll=i}),j=function(a){return a===null?"null":a===void 0?"undefined":Object.prototype.toString.call(a).slice(8,-1).toLowerCase()},namespace("Femto.utils",function(a){return a.typeOf=j})}.call(this)