((function(){var a=[].slice;window.namespace=function(b,c,d){var e,f,g,h,i,j;arguments.length<3&&(i=[typeof exports!="undefined"?exports:window].concat(a.call(arguments)),b=i[0],c=i[1],d=i[2]),f=b,j=c.split(".");for(g=0,h=j.length;g<h;g++)e=j[g],b=b[e]||(b[e]={});return d(b,f)}})).call(this),function(){var a,b,c,d,e,f,g,h,i,j,k={}.hasOwnProperty,l=function(a,b){function d(){this.constructor=a}for(var c in b)k.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},m=function(a,b){return function(){return a.apply(b,arguments)}};e=function(){function a(a){this.textarea=a,this}return a.prototype._getCaret=function(){var a,b;return b=this.textarea.selectionStart,a=this.textarea.selectionEnd,[b,a]},a.prototype._setCaret=function(a,b){return this.textarea.setSelectionRange(a,b),this},a.prototype._getWholeText=function(){return this.textarea.value},a.prototype._setWholeText=function(a){return this.textarea.value=a,this},a.prototype._replace=function(a,b,c){var d,e,f;return f=this._getWholeText(),e=f.substring(0,b),d=f.substring(c),this._setWholeText(e+a+d)},a.prototype.caret=function(a,b){var c,d;return a==null?this._getCaret():b==null?(c=this._getCaret(),this.caret(c[0]+a,c[1]+a)):(d=this.textarea.scrollTop,this._setCaret(a,b),this.textarea.scrollTop=d,this)},a.prototype.isCollapsed=function(){var a,b,c;return c=this._getCaret(),b=c[0],a=c[1],b===a},a.prototype.collapse=function(a){var b,c,d;return d=this._getCaret(),c=d[0],b=d[1],a?this._setCaret(c,c):this._setCaret(b,b),this},a.prototype.text=function(a,b){var c,d,e,f;return f=this._getCaret(),d=f[0],c=f[1],a==null?this._getWholeText().substring(d,c):(e=this.textarea.scrollTop,this._replace(a,d,c),c=d+a.length,b||(d=c),this._setCaret(d,c),this.textarea.scrollTop=e,this)},a.prototype.lineCaret=function(a,b){var c,d,e,f;if(a==null||b==null)f=this._getCaret(),d=f[0],c=f[1],a=a!=null?a:d,b=b!=null?b:c;return e=this._getWholeText(),a=e.lastIndexOf("\n",a-1)+1,b=e.indexOf("\n",b),b===-1&&(b=e.length),[a,b]},a.prototype.lineText=function(a,b){var c,d,e,f;return f=this.lineCaret(),d=f[0],c=f[1],a==null?this._getWholeText().substring(d,c):(e=this.textarea.scrollTop,this._replace(a,d,c),c=d+a.length,b||(d=c),this._setCaret(d,c),this.textarea.scrollTop=e,this)},a.prototype.insertBefore=function(a,b){var c,d,e,f,g;return g=this._getCaret(),d=g[0],c=g[1],f=this.text(),e=this.textarea.scrollTop,this._replace(a+f,d,c),c=d+a.length,b||(d=c),this._setCaret(d,c),this.textarea.scrollTop=e,this},a.prototype.insertAfter=function(a,b){var c,d,e,f,g;return g=this._getCaret(),d=g[0],c=g[1],f=this.text(),e=this.textarea.scrollTop,this._replace(f+a,d,c),d=c,c+=a.length,b||(d=c),this._setCaret(d,c),this.textarea.scrollTop=e,this},a.prototype.enclose=function(a,b,c){var d,e,f,g,h,i,j;return i=this.text(),g=this.textarea.scrollTop,e=i.lastIndexOf(b),i.indexOf(a)===0&&e===i.length-b.length?(h=i.substring(a.length,i.length-b.length),this.text(h,c)):(j=this._getCaret(),f=j[0],d=j[1],this._replace(a+i+b,f,d),d=f+a.length+i.length+b.length,c||(f=d),this._setCaret(f,d)),this.textarea.scrollTop=g,this},a.prototype.insertBeforeLine=function(a,b){var c,d,e,f,g;return g=this.lineCaret(),d=g[0],c=g[1],f=this.lineText(),e=this.textarea.scrollTop,this._replace(a+f,d,c),c=d+a.length,b||(d=c),this._setCaret(d,c),this.textarea.scrollTop=e,this},a.prototype.insertAfterLine=function(a,b){var c,d,e,f,g;return g=this.lineCaret(),d=g[0],c=g[1],f=this.lineText(),e=this.textarea.scrollTop,this._replace(f+a,d,c),d=c,c+=a.length,b||(d=c),this._setCaret(d,c),this.textarea.scrollTop=e,this},a.prototype.encloseLine=function(a,b,c){var d,e,f,g,h,i,j;return i=this.lineText(),g=this.textarea.scrollTop,e=i.lastIndexOf(b),i.indexOf(a)===0&&e===i.length-b.length?(h=i.substring(a.length,i.length-b.length),this.text(h,c)):(j=this.lineCaret(),f=j[0],d=j[1],this._replace(a+i+b,f,d),d=f+a.length+i.length+b.length,c||(f=d),this._setCaret(f,d)),this.textarea.scrollTop=g,this},a}(),namespace("Femto.utils",function(a){return a.W3CSelection=e,a.Selection=e}),document.selection!=null&&(b=function(a){function b(a){this.textarea=a,this._document=this.textarea.ownerDocument}return l(b,a),b.prototype._getWholeText=function(){return this.textarea.value.replace(/\r/g,"")},b.prototype._getCaret=function(){var a,b,c,d,e,f,g;return e=a=0,f=this.textarea,d=this._document.selection.createRange(),d&&d.parentElement()===f&&(c=f.value.replace(/\r/g,"").length,g=f.createTextRange(),g.moveToBookmark(d.getBookmark()),b=f.createTextRange(),b.collapse(!1),g.compareEndPoints("StartToEnd",b)>-1?e=a=c:(e=-g.moveStart("character",-c),g.compareEndPoints("EndToEnd",b)>-1?a=c:a=-g.moveEnd("character",-c))),[e,a]},b.prototype._setCaret=function(a,b){var c;return c=this.textarea.createTextRange(),c.collapse(!0),c.moveStart("character",a),c.moveEnd("character",b-a),c.select(),this},b}(Femto.utils.W3CSelection),namespace("Femto.utils",function(a){return a.IESelection=b,a.Selection=b})),j=function(a,b,c){var d,e,f,g;return a==null&&(a="<div>"),e=function(a,b){var c;return a==null||!a?!1:(c=Object.prototype.toString.call(a)[{8:-1}].toLowerCase(),c===b)},a instanceof jQuery?d=a:d=$(a,b),g=jQuery.prototype.outerWidth,f=jQuery.prototype.outerHeight,d.nonContentWidth=function(a){return a==null&&(a=!1),g.call(this,a)-this.width()},d.nonContentHeight=function(a){return a==null&&(a=!1),f.call(this,a)-this.height()},d.outerWidth=function(a,b){var c;return e(a,"number")&&(b=a,a=!1),b==null?g.call(this):(c=this.nonContentWidth(a),this.width(b-c))},d._outerHeight=d.outerHeight,d.outerHeight=function(a,b){var c;return e(a,"number")&&(b=a,a=!1),b==null?f.call(this):(c=this.nonContentHeight(a),this.height(b-c))},d.widget="widget",d},namespace("Femto.widgets",function(a){return a.widget=j}),c=function(){function a(){}return a.prototype.createMemento=function(){throw Error("Not implemented yet")},a.prototype.setMemento=function(a){throw Error("Not implemented yet")},a}(),a=function(){function a(a){this._originator=a,this._undoStack=[],this._redoStack=[],this._previous=null}return a.prototype.originator=function(a){return a!=null?(this._originator=a,this):this._originator},a.prototype.save=function(a){a=a||this.originator().createMemento();if(this._previous==null||this._previous!==a)this._undoStack.length===0&&a!==""&&this._undoStack.push(""),this._undoStack.push(a),this._redoStack=[],this._previous=a;return this},a.prototype.undo=function(){var a;return this.canUndo()?(a=this.originator(),this._redoStack.push(a.createMemento()),a.setMemento(this._undoStack.pop()),this):this},a.prototype.redo=function(){var a;return this.canRedo()?(a=this.originator(),this._undoStack.push(a.createMemento()),a.setMemento(this._redoStack.pop()),this):this},a.prototype.canUndo=function(){return this._undoStack.length>0},a.prototype.canRedo=function(){return this._redoStack.length>0},a}(),typeof exports!="undefined"&&exports!==null&&(exports.Originator=c,exports.Caretaker=a),typeof namespace!="undefined"&&namespace!==null&&namespace("Femto.utils",function(b){return b.Originator=c,b.Caretaker=a}),h=function(a){var b;return b=""+a+"Cache",h[b]==null&&(h[b]=(new Array(a+1)).join(" ")),h[b]},d=function(){function a(a,b,c,d){var e;this.textarea=a,this.selection=b,this.expandTab=c!=null?c:!0,this.indentLevel=d!=null?d:4,this._keyDownEvent=m(this._keyDownEvent,this),this.textarea instanceof jQuery||(this.textarea=jQuery(this.textarea)),this.expandTab?e=h(this.indentLevel):e="\t",this._pattern=new RegExp("^(?:"+e+")*")}return a.prototype.indent=function(){var a,b,c,d,e,f,g,i,j,k,l,m,n,o,p,q,r,s=this;return b=this.selection.isCollapsed(),n=this.selection.text(),q=this.selection.caret(),c=q[0],a=q[1],r=this.selection.lineCaret(),i=r[0],g=r[1],!b&&n.indexOf("\n")!==-1?(e=function(a){var b,c,d;return s.expandTab?(c=a.length-a.replace(/^\s*/,"").length,b=c%s.indentLevel,d=h(s.indentLevel-b)):d="\t",d+a},n=this.selection.lineText().split("\n"),j=function(){var a,b,c;c=[];for(a=0,b=n.length;a<b;a++)f=n[a],c.push(e(f));return c}(),this.selection.lineText(j.join("\n"),!1),l=j[0].length-n[0].length,k=j.join("").length-n.join("").length,i!==c&&(c+=l),this.selection.caret(c,a+k)):(this.expandTab?(m=c-i,d=m%this.indentLevel,p=h(this.indentLevel-d)):p="\t",o=p.length,this.selection.text(p+n,!1),this.selection.caret(c+o,a+o)),this},a.prototype.outdent=function(){var a,b,c,d,e,f,g,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x=this;d=this.selection.isCollapsed(),s=this.selection.text(),l=this.selection.lineText(),v=this.selection.caret(),e=v[0],c=v[1],w=this.selection.lineCaret(),m=w[0],j=w[1];if(!d&&s.indexOf("\n")!==-1)q=function(a){var b,c,d;return x.expandTab?(c=a.length-a.replace(/^\s*/,"").length,b=c%x.indentLevel,d=h(x.indentLevel-b)):d="\t",a.replace(new RegExp("^"+d),"")},s=this.selection.lineText().split("\n"),n=function(){var a,b,c;c=[];for(a=0,b=s.length;a<b;a++)i=s[a],c.push(q(i));return c}(),this.selection.lineText(n.join("\n"),!1),p=s[0].length-n[0].length,o=s.join("").length-n.join("").length,m!==e&&(e-=p),this.selection.caret(e,c-o);else{this.expandTab?(k=s.length-s.replace(/^\s*/,"").length,r=e-m+k,f=r%this.indentLevel,u=h(this.indentLevel-f)):u="\t",t=u.length,g=l.lastIndexOf(u,e-m);if(g===-1)return this;b=l.substring(0,g),a=l.substring(g+u.length),this.selection.lineText(b+a,!1),this.selection.caret(e-t,c-t)}return this},a.prototype.insertNewLine=function(){var a,b,c,d,e,f,g;return g=this.selection.caret(),e=g[0],a=g[1],f=this.selection._getWholeText(),d=f.lastIndexOf("\n",a-1)+1,b=f.slice(d,a).match(this._pattern),c="\n"+b,this.selection.insertAfter(c,!1),e===a?this.selection.caret(e+c.length,e+c.length):this.selection.caret(e,a+c.length),this},a.prototype._keyDownEvent=function(a){if(a.which!==9&&a.which!==13)return!0;if(a.which===9)a.shiftKey?this.outdent():this.indent();else if(a.which===13){if(a.shiftKey)return!0;this.insertNewLine()}return!1},a.prototype.enable=function(){return this.textarea.on("keydown",this._keyDownEvent),this},a.prototype.disable=function(){return this.textarea.off("keydown",this._keyDownEvent),this},a}(),namespace("Femto.utils",function(a){return a.Shifter=d}),i=function(a,b,c){var d,e,f,g;return e=Femto.widgets.widget(a,b),e.createMemento=e.val,e.setMemento=e.val,d=new Femto.utils.Caretaker(e),d.save(),d._keyDownEvent=function(a){var b;return((b=a.which)===13||b===9||b===8||b===46)&&d.save(),a.which===90&&a.ctrlKey?(a.shiftKey?d.redo():d.undo(),!1):!0},f=new Femto.utils.Selection(e.get(0)),g=new Femto.utils.Shifter(e,f,c.expandTab,c.indentLevel),e.on("keydown",function(a){var b;return b=d._keyDownEvent(a),b&&(b=g._keyDownEvent(a)),b}),e.on("paste,drop",function(a){return d.save()}),e._caretaker=d,e._selection=f,e._shifter=g,e.save=function(){var a;return(a=this._caretaker).save.apply(a,arguments)},e.undo=function(){var a;return(a=this._caretaker).undo.apply(a,arguments)},e.redo=function(){var a;return(a=this._caretaker).redo.apply(a,arguments)},e.indent=function(){var a;return(a=this._shifter).indent.apply(a,arguments)},e.outdent=function(){var a;return(a=this._shifter).outdent.apply(a,arguments)},e.insertNewLine=function(){var a;return(a=this._shifter).insertNewLine.apply(a,arguments)},e.widget="textarea",e},namespace("Femto.widgets",function(a){return a.textarea=i}),f=function(a,b,c){var d;return i=Femto.widgets.textarea(a,b,c),i.css({margin:"0",padding:"0",border:"none",outline:"none",resize:"none",width:"100%",height:"100%"}),d=Femto.widgets.widget(),d.addClass("panel").addClass("editor"),d.append(i),d.textarea=i,d.selection=i._selection,d.caretaker=i._caretaker,d.shifter=i._shifter,d.focus=function(){return i.focus(),this},d.blar=function(){return i.blar(),this},d.val=function(){return i.val.apply(i,arguments)},d.widget="editor",d},namespace("Femto.widgets",function(a){return a.editor=f}),g=function(a,b){var c;return Femto.options=b,c=Femto.widgets.widget(),c.insertAfter(a).addClass("femto").hide(),c.editor=Femto.widgets.editor(a,null,b),c.append(c.editor),c.show()},jQuery.fn.femto=function(a){var b;return b={expandTab:!0,indentLevel:4},a=jQuery.extend(b,a),this.each(function(b){var c;return c=$(this),c.data("femto",g(c,a))})}}.call(this)